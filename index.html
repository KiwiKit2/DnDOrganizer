<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DnDex</title>
  <base href="./">
  <meta name="description" content="DnDex ‚Äî simple, collaborative VTT and organizer with scenes, fog, walls, and live cursors." />
  <meta name="theme-color" content="#0d0f11" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%234f8dff'/%3E%3Ctext x='50' y='60' font-size='56' text-anchor='middle' fill='white' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app" class="app-shell">
    <aside class="sidebar" id="sidebar">
  <div class="brand">DnDex</div>
      <nav class="nav">
        <button class="nav-btn active" data-view="moves">Moves</button>
        <button class="nav-btn" data-view="entities">Entities</button>
        <button class="nav-btn" data-view="board">Kanban</button>
        <button class="nav-btn" data-view="map">Board</button>
        <button class="nav-btn" data-view="table">Table</button>
        <button class="nav-btn" data-view="about">About</button>
      </nav>
      <div class="sidebar-footer">
        <button id="refreshBtn" class="accent-btn" title="Reload data">‚Üª Refresh</button>
        <label class="toggle tiny">
          <input type="checkbox" id="autoRefreshToggle" checked>
          <span>Auto</span>
        </label>
      </div>
    </aside>
    <main class="main">
      <header class="topbar">
        <div class="breadcrumbs" id="statusLine">Loading‚Ä¶</div>
  <div class="spacer"></div>
  <label class="toggle" title="Lean mode"><input type="checkbox" id="leanToggle" /> <span>Lean</span></label>
  <button id="sheetConfigBtn" class="mini-btn" title="Configure sheet">‚öôÔ∏è</button>
  <button id="uploadBtn" class="mini-btn" title="Upload local Excel/CSV">Upload</button>
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none" />
  <a class="mini-btn" id="templateLink" href="assets/template.csv" download>Template</a>
  <button id="sampleDataBtn" class="mini-btn" title="Insert sample data">Sample</button>
        <input type="search" id="search" placeholder="Search‚Ä¶" autocomplete="off" />
  <button id="adminToggle" class="mini-btn" title="Toggle admin editing">Admin Off</button>
  <button id="resetAppBtn" class="mini-btn danger" title="Reset app (clears local data)">Reset</button>
        <button id="themeSwitch" title="Toggle theme">üåô</button>
      </header>

      <section id="view-table" class="view active">
        <div class="toolbar">
          <div class="left-tools">
            <select id="columnFilter"></select>
            <select id="valueFilter"></select>
          </div>
          <div class="right-tools">
            <button id="exportJson" class="mini-btn">Export JSON</button>
            <button id="exportCsv" class="mini-btn">Export CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-moves" class="view active">
        <div class="moves-layout">
          <div class="moves-editor card-panel" id="movesEditorPanel">
            <h2 class="panel-title">Create / Edit Move</h2>
            <form id="moveForm" autocomplete="off">
              <label>Name<input name="name" required placeholder="Fireball" /></label>
              <label>Description<textarea name="description" placeholder="Area explosion dealing 8d6 fire"></textarea></label>
              <label>Tags (comma separated)<input name="tags" placeholder="fire, area, damage" /></label>
              <label>Image URL<input name="image" placeholder="https://.../fireball.png" /></label>
              <div class="row-btns">
                <button type="button" id="addMoveBtn" class="accent-btn">Save Move</button>
                <button type="button" id="resetMoveBtn" class="mini-btn">Clear</button>
                <button type="button" id="exportMovesBtn" class="mini-btn">Export Excel</button>
                <button type="button" id="importMovesBtn" class="mini-btn">Import Excel</button>
                <input type="file" id="importMovesInput" accept=".xlsx,.xls" style="display:none" />
              </div>
            </form>
          </div>
          <div class="moves-list card-panel">
            <div class="moves-toolbar">
              <input type="search" id="moveSearch" placeholder="Search moves by name or tag‚Ä¶" />
            </div>
            <table id="movesTable" class="moves-table">
              <thead><tr><th>Name</th><th>Description</th><th>Tags</th><th class="actions-col">Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="movesEmpty" class="empty-hint hidden">No moves yet. Add one on the left.</div>
          </div>
        </div>
      </section>

      <section id="view-entities" class="view">
        <div class="comp-toolbar">
          <input type="search" id="compSearch" placeholder="Search entities‚Ä¶" />
          <label><input type="checkbox" id="showPlayers" checked /> Players</label>
          <label><input type="checkbox" id="showItems" checked /> Items</label>
          <label><input type="checkbox" id="showEnemies" checked /> Enemies</label>
          <button id="newEntryBtn" class="mini-btn admin-only">New Entry</button>
        </div>
        <div id="compGallery" class="grid-board"></div>
        <div id="compDetail" class="comp-detail hidden"></div>
      </section>

      <section id="view-board" class="view">
        <div class="board-toolbar">
          <label>Group by <select id="groupSelect"></select></label>
          <button id="addCardBtn" class="mini-btn">New Card</button>
        </div>
  <div id="boardSummary" class="board-summary"></div>
        <div id="kanban" class="kanban"></div>
        <div id="kanbanEmpty" class="empty-hint hidden">No cards to show. Load data or add a new card.</div>
      </section>

      <section id="view-map" class="view">
        <div class="map-toolbar">
          <button id="addTokensBtn" class="mini-btn">Add Filtered as Tokens</button>
          <label>Grid <input type="number" id="gridSizeInput" value="50" min="20" max="120" step="5" style="width:70px" /></label>
          <button id="clearTokensBtn" class="mini-btn">Clear Tokens</button>
          <button id="addSingleTokenBtn" class="mini-btn">Add Token</button>
          <label>Snap <input type="checkbox" id="snapToggle" checked /></label>
          <label class="toggle"><input type="checkbox" id="simpleModeToggle" checked /> <span>Simple Mode</span></label>
          <label class="toggle"><input type="checkbox" id="perfModeToggle" /> <span>Perf Mode</span></label>
          <label class="toggle"><input type="checkbox" id="lockBoardToggle" /> <span>Lock</span></label>
          <label class="toggle"><input type="checkbox" id="cursorsToggle" checked /> <span>Cursors</span></label>
          <div class="fog-group">
            <button id="fogFullBtn" class="mini-btn">Fog Full</button>
            <button id="fogRevealBtn" class="mini-btn">Reveal</button>
            <button id="fogClearBtn" class="mini-btn">Clear Fog</button>
          </div>
          <div class="map-tools-group">
            <button id="wallModeBtn" class="mini-btn" title="Draw walls">Walls</button>
            <button id="visionToggleBtn" class="mini-btn" title="Toggle auto vision reveal">Vision Auto</button>
            <button id="rulerBtn" class="mini-btn" title="Measure distance (M)">Ruler</button>
            <div class="aoe-group">
              <button id="addCircleTemplateBtn" class="mini-btn" title="Add circle template">‚óØ</button>
              <button id="addConeTemplateBtn" class="mini-btn" title="Add cone template">‚åî</button>
              <button id="addLineTemplateBtn" class="mini-btn" title="Add line template">Ôºè</button>
            </div>
            <div class="fog-adv-group">
              <label>Brush <input type="range" id="fogBrushSize" min="20" max="200" value="90"></label>
              <select id="fogBrushShape"><option value="circle">Circle</option><option value="rect">Square</option></select>
              <button id="fogUndoBtn" class="mini-btn" title="Undo fog step">Undo</button>
            </div>
            <button id="bgImageBtn" class="mini-btn" title="Set background image">BG Img</button>
            <button id="exportBoardBtn" class="mini-btn" title="Export board state">Export</button>
            <button id="importBoardBtn" class="mini-btn" title="Import board state">Import</button>
            <input type="file" id="bgImageInput" accept="image/*" style="display:none" />
            <input type="file" id="importBoardInput" accept="application/json" style="display:none" />
            <div class="scenes-group">
              <label>Scene <select id="sceneSelect"></select></label>
              <button id="sceneSaveBtn" class="mini-btn" title="Save current as scene">Save</button>
              <button id="sceneLoadBtn" class="mini-btn" title="Load selected scene">Load</button>
              <button id="sceneManageBtn" class="mini-btn" title="Manage scenes">Manage</button>
            </div>
            <div class="layer-toggles">
              <label><input type="checkbox" id="showFogToggle" checked /> Fog</label>
              <label><input type="checkbox" id="showWallsToggle" checked /> Walls</label>
              <label><input type="checkbox" id="showTemplatesToggle" checked /> Templates</label>
              <label><input type="checkbox" id="collideWallsToggle" /> Collide</label>
              <label><input type="checkbox" id="gmModeToggle" /> GM Mode</label>
            </div>
            <div class="mp-group">
              <button id="hostGameBtn" class="mini-btn" title="Host a session as GM">Host</button>
              <button id="joinGameBtn" class="mini-btn" title="Join a session as Player/GM">Join</button>
              <button id="shareGameBtn" class="mini-btn" title="Copy join link">Share</button>
              <label title="Allow players to edit the board"><input type="checkbox" id="playersEditToggle" /> Players Edit</label>
              <span id="mpStatus" class="mp-status">Offline</span>
            </div>
            <button id="clearWallsBtn" class="mini-btn" title="Delete all walls">Clear Walls</button>
            <button id="clearTemplatesBtn" class="mini-btn" title="Delete all templates">Clear Templates</button>
            <button id="exportImageBtn" class="mini-btn" title="Export map as PNG">Export PNG</button>
            <button id="mapHelpBtn" class="mini-btn" title="Show map help">Help</button>
          </div>
        </div>
  <div id="sessionBanner" class="session-banner" aria-live="polite"></div>
  <div id="mapStage" class="map-stage">
          <canvas id="battleMap" width="1200" height="800"></canvas>
          <div class="token-layer" id="tokenLayer"></div>
          <canvas class="walls-layer" id="wallsCanvas" width="1200" height="800"></canvas>
          <canvas class="fog-layer" id="fogCanvas" width="1200" height="800"></canvas>
          <canvas class="overlay-layer" id="overlayCanvas" width="1200" height="800"></canvas>
          <div class="cursor-layer" id="cursorLayer" aria-hidden="true"></div>
        </div>
  <div id="toast" class="toast hidden"></div>

        <!-- Multiplayer modal -->
        <div id="mpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2>Multiplayer</h2><button id="closeMpModal" class="close-btn" aria-label="Close">√ó</button></header>
            <div class="form-grid">
              <label>Server URL<input id="mpServerUrl" placeholder="wss://your-relay.example.com" /></label>
              <label>Room Code<input id="mpRoomCode" placeholder="my-room-123" /></label>
              <label>Your Name<input id="mpName" placeholder="Player" /></label>
              <div class="row-btns">
                <button id="mpDoHost" class="accent-btn">Host as GM</button>
                <button id="mpDoJoin" class="mini-btn">Join</button>
              </div>
              <small>Tip: As GM, start the server locally and click Host. Share Room Code and your Server URL to players.</small>
            </div>
          </div>
        </div>

  <div id="mapHelpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2>Map Controls</h2><button id="closeMapHelp" class="close-btn" aria-label="Close">√ó</button></header>
            <ul>
              <li><strong>Walls:</strong> Click start‚Üíend to draw. Alt+click to delete. Ctrl+Z / Ctrl+Y to undo/redo.</li>
              <li><strong>Tokens:</strong> Click to select; Ctrl/Shift for multi. Drag to move; Shift+drag empty area = marquee select.</li>
              <li><strong>Context Menu:</strong> Right‚Äëclick token to set Vision, HP, Type; Duplicate or Delete.</li>
              <li><strong>Vision:</strong> Toggle Vision Auto; Set per‚Äëtoken radius. Walls block line of sight.</li>
              <li><strong>Fog:</strong> Fog Full/Clear; Reveal brush with size/shape; Undo.</li>
              <li><strong>Ruler:</strong> Click then drag. Shows px and squares. Respects Snap.</li>
              <li><strong>AoE Templates:</strong> Add Circle/Cone/Line; drag to move; Shift+drag to resize; mouse wheel to rotate; Delete to remove.</li>
              <li><strong>Initiative:</strong> Select tokens ‚Üí Add Sel; ‚óÄ ‚ñ∂ to cycle; Clear to reset.</li>
              <li><strong>GM Mode:</strong> Hides fog for you; players would see fog.</li>
            </ul>
          </div>
        </div>
        <div class="map-panels">
          <div class="initiative-panel" id="initiativePanel">
            <div class="panel-head">Initiative
              <div class="panel-actions">
                <button id="initAddBtn" class="mini-btn">Add Sel</button>
                <button id="initPrevBtn" class="mini-btn">‚óÄ</button>
                <button id="initNextBtn" class="mini-btn">‚ñ∂</button>
                <button id="initClearBtn" class="mini-btn">Clear</button>
              </div>
            </div>
            <ol id="initiativeList"></ol>
          </div>
          <div class="token-panel" id="tokenInspector">
            <div class="panel-head">Token Inspector</div>
            <div class="tp-body">
              <label>Name<input id="tiName" placeholder="token name" /></label>
              <label>Type
                <select id="tiType">
                  <option value="">Neutral</option>
                  <option value="player">Player</option>
                  <option value="enemy">Enemy</option>
                </select>
              </label>
              <label>HP<input id="tiHP" type="number" min="0" step="1" placeholder="" /></label>
              <label>Vision (px)<input id="tiVision" type="number" min="0" step="10" placeholder="180" /></label>
            </div>
          </div>
          <div class="scene-panel hidden" id="scenePanel">
            <div class="panel-head">Scenes
              <div class="panel-actions">
                <button id="scenePanelClose" class="mini-btn">Close</button>
              </div>
            </div>
            <ul id="sceneList"></ul>
            <div class="panel-actions" style="margin-top:8px">
              <button id="sceneDeleteAllBtn" class="mini-btn danger">Delete All</button>
            </div>
          </div>
        </div>
        <p class="map-hint">Drag tokens. Walls mode to draw barriers. Vision Auto reveals based on token radius (right‚Äëclick token ‚Üí Set Vision). Ruler (M) to measure. Export to save board JSON.</p>
      </section>

  <!-- entities replaces compendium -->

      <section id="view-about" class="view prose">
        <h1>About</h1>
        <p>This dashboard pulls live data from a Google Sheet you control. Edit the sheet, refresh here, done.</p>
        <ol>
          <li>Open your sheet in Google Sheets.</li>
          <li>File ‚Üí Share ‚Üí Publish to web ‚Üí Select the tab ‚Üí CSV ‚Üí Publish.</li>
          <li>Copy the generated URL and paste it into <code>config.js</code> (GOOGLE_SHEET_CSV_URL).</li>
          <li>Reload this page.</li>
        </ol>
        <p>Use search, filters, board view, and quick export. Data never leaves your browser.</p>
      </section>

      <footer class="footer">Live sheet sync ‚Ä¢ <span id="recordCount">0</span> rows ‚Ä¢ <span id="lastUpdated">‚Äî</span></footer>
    </main>
  </div>
  <button id="helpFab" class="help-fab" title="Help">?</button>
  <div id="sheetModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel">
      <header><h2>Sheet Source</h2><button id="closeSheetModal" class="close-btn" aria-label="Close">√ó</button></header>
      <p>Paste the Published CSV URL from Google Sheets. (File ‚Üí Share ‚Üí Publish to web ‚Üí CSV)</p>
      <textarea id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"></textarea>
      <div class="actions">
        <button id="saveSheetUrl" class="accent-btn">Save & Reload</button>
        <button id="clearSheetUrl" class="mini-btn">Clear Override</button>
  <button id="modalUploadBtn" class="mini-btn" type="button">Upload Local File‚Ä¶</button>
      </div>
      <small>Stored locally in your browser. Share the link hash like <code>#sheet=&lt;url&gt;</code> to preload.</small>
    </div>
  </div>
  <div id="editorModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel edit-panel">
      <header><h2 id="editTitle">Edit Row</h2><button id="closeEditorModal" class="close-btn" aria-label="Close">√ó</button></header>
      <form id="editForm"></form>
      <div class="actions">
        <button id="saveRowBtn" class="accent-btn" type="button">Save</button>
        <button id="deleteRowBtn" class="mini-btn danger" type="button">Delete</button>
      </div>
    </div>
  </div>
  <!-- Landing: Table selection (DnDex) -->
  <div id="welcomeModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-panel" style="max-width:520px">
      <header><h2>Welcome to DnDex</h2></header>
      <div class="welcome-simple">
        <label>Your Name<input id="wlName" placeholder="GM or Player" /></label>
        <button id="wlCreate" class="accent-btn">Create a Table (GM)</button>
        <div class="or-sep">or</div>
        <label>Invite Link<input id="wlInvite" placeholder="Paste a DnDex invite link here" /></label>
        <button id="wlJoin" class="mini-btn">Join</button>
        <button id="wlSolo" class="mini-btn">Solo Mode</button>
        <label>Relay URL (saved)
          <input id="wlServerInline" placeholder="wss://your-relay.example.com" />
        </label>
        <button id="wlAdvanced" class="mini-btn" title="Open full options">Advanced‚Ä¶</button>
        <small style="opacity:.75">Create generates a room code and uses your saved relay (wss://). Join works by pasting an invite link.</small>
      </div>
    </div>
  </div>
  <div id="dropOverlay" class="drop-overlay hidden" title="Click to dismiss">Drag & release a CSV/XLSX here to load</div>
  <script src="js/config.js"></script>
  <script src="js/persist.js"></script>
  <script src="js/sheet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/compendium.js"></script>
  <script>if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{})); }</script>
</body>
</html>
