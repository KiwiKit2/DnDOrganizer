<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DnDex</title>
  <base href="./">
  <meta name="description" content="DnDex ‚Äî simple, collaborative VTT and organizer with scenes, fog, walls, and live cursors." />
  <meta name="theme-color" content="#0d0f11" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%234f8dff'/%3E%3Ctext x='50' y='60' font-size='56' text-anchor='middle' fill='white' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app" class="app-shell">
    <aside class="sidebar" id="sidebar">
  <div class="brand">DnDex</div>
      <nav class="nav">
        <button class="nav-btn active" data-view="moves">Moves</button>
        <button class="nav-btn" data-view="entities">Entities</button>
        <button class="nav-btn" data-view="board">Kanban</button>
        <button class="nav-btn" data-view="table">Table</button>
  <button class="nav-btn" data-view="character">Character</button>
        <button class="nav-btn" data-view="about">About</button>
      </nav>
      <div class="sidebar-footer">
        <button id="refreshBtn" class="accent-btn" title="Reload data">‚Üª Refresh</button>
        <label class="toggle tiny">
          <input type="checkbox" id="autoRefreshToggle" checked>
          <span>Auto</span>
        </label>
      </div>
    </aside>
    <main class="main">
      <header class="topbar">
        <div class="breadcrumbs" id="statusLine">Loading‚Ä¶</div>
  <div class="spacer"></div>
  <label class="toggle hide-on-map hidden" title="Lean mode"><input type="checkbox" id="leanToggle" /> <span>Lean</span></label>
  <button id="sheetConfigBtn" class="mini-btn hide-on-map" title="Configure sheet">‚öôÔ∏è</button>
  <button id="uploadBtn" class="mini-btn hide-on-map" title="Upload local Excel/CSV">Upload</button>
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none" />
  <a class="mini-btn hide-on-map" id="templateLink" href="assets/template.csv" download>Template</a>
  <button id="sampleDataBtn" class="mini-btn hide-on-map" title="Insert sample data">Sample</button>
    <input type="search" id="search" class="hide-on-map" placeholder="Search‚Ä¶" autocomplete="off" />
  <button id="adminToggle" class="mini-btn hide-on-map hidden" title="Toggle admin editing">Admin Off</button>
  <button id="resetAppBtn" class="mini-btn danger hide-on-map hidden" title="Reset app (clears local data)">Reset</button>
        <button id="themeSwitch" title="Toggle theme">üåô</button>
      </header>

  <section id="view-table" class="view">
        <div class="toolbar">
          <div class="left-tools">
            <select id="columnFilter"></select>
            <select id="valueFilter"></select>
          </div>
          <div class="right-tools">
            <button id="exportJson" class="mini-btn">Export JSON</button>
            <button id="exportCsv" class="mini-btn">Export CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-moves" class="view active">
        <div class="moves-layout">
          <div class="moves-editor card-panel" id="movesEditorPanel">
            <h2 class="panel-title">Create / Edit Move</h2>
            <form id="moveForm" autocomplete="off">
              <div class="form-row">
                <label>Name<input name="name" required placeholder="Fireball" /></label>
              </div>
              
              <div class="form-row">
                <label>Category
                  <select name="category">
                    <option value="">Select category...</option>
                    <option value="attack">Attack</option>
                    <option value="spell">Spell</option>
                    <option value="utility">Utility</option>
                    <option value="defense">Defense</option>
                    <option value="movement">Movement</option>
                    <option value="social">Social</option>
                    <option value="other">Other</option>
                  </select>
                </label>
              </div>
              
              <div class="form-row">
                <label>Description<textarea name="description" placeholder="Area explosion dealing 8d6 fire damage to all creatures in a 20-foot radius"></textarea></label>
              </div>
              
              <div class="form-row two-col">
                <label>Damage/Effect<input name="damage" placeholder="8d6 fire" /></label>
                <label>Range<input name="range" placeholder="150 feet" /></label>
              </div>
              
              <div class="form-row">
                <label>Tags (comma separated)<input name="tags" placeholder="fire, area, damage, spell" /></label>
              </div>
              
              <div class="form-row">
                <label>Image Upload
                  <input type="file" name="imageFile" accept="image/*" class="file-input" />
                  <div class="image-preview-container hidden" id="imagePreviewContainer">
                    <img id="imagePreview" class="image-preview" />
                    <button type="button" class="mini-btn" id="removeImage">Remove Image</button>
                  </div>
                </label>
              </div>
              
              <div class="form-actions">
                <button type="button" id="addMoveBtn" class="accent-btn">Save Move</button>
                <button type="button" id="resetMoveBtn" class="mini-btn">Clear</button>
                <button type="button" id="exportMovesBtn" class="mini-btn">Export</button>
                <button type="button" id="importMovesBtn" class="mini-btn">Import</button>
                <input type="file" id="importMovesInput" accept=".xlsx,.xls" style="display:none" />
              </div>
            </form>
          </div>
          <div class="moves-list card-panel">
            <div class="moves-toolbar">
              <input type="search" id="moveSearch" placeholder="Search moves by name, category, or tag..." />
              <select id="categoryFilter" class="mini-select">
                <option value="">All Categories</option>
                <option value="attack">Attack</option>
                <option value="spell">Spell</option>
                <option value="utility">Utility</option>
                <option value="defense">Defense</option>
                <option value="movement">Movement</option>
                <option value="social">Social</option>
                <option value="other">Other</option>
              </select>
            </div>
            <table id="movesTable" class="moves-table">
              <thead><tr><th>Name</th><th>Category</th><th>Description</th><th>Damage/Range</th><th>Tags</th><th class="actions-col">Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="movesEmpty" class="empty-hint hidden">
              <div class="empty-content">
                <h3>No moves yet</h3>
                <p>Create your first move using the form on the left.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-entities" class="view">
        <div class="comp-toolbar">
          <input type="search" id="compSearch" placeholder="Search entities‚Ä¶" />
          <label><input type="checkbox" id="showPlayers" checked /> Players</label>
          <label><input type="checkbox" id="showItems" checked /> Items</label>
          <label><input type="checkbox" id="showEnemies" checked /> Enemies</label>
          <button id="newEntryBtn" class="mini-btn admin-only">New Entry</button>
        </div>
        <div id="compGallery" class="grid-board"></div>
        <div id="compDetail" class="comp-detail hidden"></div>
      </section>

      <section id="view-board" class="view">
        <div class="board-toolbar">
          <label>Group by <select id="groupSelect"></select></label>
          <button id="addCardBtn" class="mini-btn">New Card</button>
        </div>
  <div id="boardSummary" class="board-summary"></div>
        <div id="kanban" class="kanban"></div>
        <div id="kanbanEmpty" class="empty-hint hidden">No cards to show. Load data or add a new card.</div>
      </section>

      <section id="view-map" class="view">
        <div class="map-toolbar compact">
          <div class="map-left">
            <button id="addSingleTokenBtn" class="mini-btn">Add Token</button>
            <button id="wallModeBtn" class="mini-btn">Walls</button>
            <button id="fogRevealBtn" class="mini-btn">Reveal</button>
            <button id="rulerBtn" class="mini-btn">Ruler</button>
            <button id="fogFullBtn" class="mini-btn">Cover All</button>
            <button id="fogClearBtn" class="mini-btn">Clear All</button>
          </div>
          <div class="map-right">
            <label>Grid <input type="number" id="gridSizeInput" value="50" min="20" max="120" step="5" style="width:70px" /></label>
            <label>Snap <input type="checkbox" id="snapToggle" checked /></label>
            <button id="exportImageBtn" class="mini-btn" title="Export PNG">PNG</button>
            <label class="toggle"><input type="checkbox" id="visionAutoToggle" checked/> <span>Vision</span></label>
            <button id="mapMoreBtn" class="mini-btn">More‚Ä¶</button>
          </div>
        </div>
        <div id="mapMorePanel" class="map-more hidden">
          <div class="more-row">
            <!-- Moved fog buttons to main toolbar for better accessibility -->
            <label class="toggle"><input type="checkbox" id="cursorsToggle" checked /> <span>Cursors</span></label>
          </div>
          <div class="more-row">
            <div class="fog-adv-group">
              <label>Brush <input type="range" id="fogBrushSize" min="20" max="200" value="90"></label>
              <select id="fogBrushShape"><option value="circle">Circle</option><option value="rect">Square</option></select>
              <button id="fogUndoBtn" class="mini-btn" title="Undo fog step">Undo</button>
            </div>
            <button id="bgImageBtn" class="mini-btn" title="Set background image">BG Img</button>
            <input type="file" id="bgImageInput" accept="image/*" style="display:none" />
          </div>
          <div class="more-row">
            <div class="scenes-group">
              <label>Scene <select id="sceneSelect"></select></label>
              <button id="sceneSaveBtn" class="mini-btn" title="Save current as scene">Save</button>
              <button id="sceneLoadBtn" class="mini-btn" title="Load selected scene">Load</button>
              <button id="sceneManageBtn" class="mini-btn" title="Manage scenes">Manage</button>
            </div>
            <div class="layer-toggles">
              <label><input type="checkbox" id="showFogToggle" checked /> Fog</label>
              <label><input type="checkbox" id="showWallsToggle" checked /> Walls</label>
              <label><input type="checkbox" id="showTemplatesToggle" checked /> Templates</label>
            </div>
            <button id="clearWallsBtn" class="mini-btn" title="Delete all walls">Clear Walls</button>
            <button id="clearTemplatesBtn" class="mini-btn" title="Delete all templates">Clear Templates</button>
          </div>
        </div>
  <div id="sessionBanner" class="session-banner" aria-live="polite"></div>
  <div id="mapStage" class="map-stage">
          <canvas id="battleMap" width="1200" height="800"></canvas>
          <div class="token-layer" id="tokenLayer"></div>
          <canvas class="walls-layer" id="wallsCanvas" width="1200" height="800"></canvas>
          <canvas class="fog-layer" id="fogCanvas" width="1200" height="800"></canvas>
          <canvas class="overlay-layer" id="overlayCanvas" width="1200" height="800"></canvas>
          <div class="cursor-layer" id="cursorLayer" aria-hidden="true"></div>
        </div>
  <div id="toast" class="toast hidden"></div>

        <!-- Multiplayer modal -->
        <div id="mpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2>Multiplayer</h2><button id="closeMpModal" class="close-btn" aria-label="Close">√ó</button></header>
            <div class="form-grid">
              <label>Server URL<input id="mpServerUrl" placeholder="wss://your-relay.example.com" /></label>
              <label>Room Code<input id="mpRoomCode" placeholder="my-room-123" /></label>
              <label>Your Name<input id="mpName" placeholder="Player" /></label>
              <div class="row-btns">
                <button id="mpDoHost" class="accent-btn">Host as GM</button>
                <button id="mpDoJoin" class="mini-btn">Join</button>
              </div>
              <small>Tip: As GM, start the server locally and click Host. Share Room Code and your Server URL to players.</small>
              <hr />
              <label class="toggle"><input type="checkbox" id="mpUseFirebase" /> <span>Use Firebase (no server)</span></label>
              <label>Firebase Config (JSON)
                <textarea id="mpFirebaseConfig" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"https://<project>.firebaseio.com","projectId":"..."}'></textarea>
              </label>
              <div class="row-btns">
                <button id="mpSaveFirebase" class="mini-btn">Save Firebase</button>
              </div>
              <small>Paste Realtime Database web config from your Firebase project. This avoids running a relay.</small>
            </div>
          </div>
        </div>

  <div id="mapHelpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2 id="helpTitle">Quick Help</h2><button id="closeMapHelp" class="close-btn" aria-label="Close">√ó</button></header>
            <div id="helpContent"></div>
          </div>
        </div>
        <div class="map-panels">
          <div class="initiative-panel" id="initiativePanel">
            <div class="panel-head">Initiative
              <div class="panel-actions">
                <button id="initAddBtn" class="mini-btn">Add Sel</button>
                <button id="initPrevBtn" class="mini-btn">‚óÄ</button>
                <button id="initNextBtn" class="mini-btn">‚ñ∂</button>
                <button id="initClearBtn" class="mini-btn">Clear</button>
              </div>
            </div>
            <ol id="initiativeList"></ol>
          </div>
          <div class="token-panel" id="tokenInspector">
            <div class="panel-head">Token Inspector</div>
            <div class="tp-body">
              <label>Name<input id="tiName" placeholder="token name" /></label>
              <label>Type
                <select id="tiType">
                  <option value="">Neutral</option>
                  <option value="player">Player</option>
                  <option value="enemy">Enemy</option>
                </select>
              </label>
              <label>HP<input id="tiHP" type="number" min="0" step="1" placeholder="" /></label>
              <label>Vision (px)<input id="tiVision" type="number" min="0" step="10" placeholder="180" /></label>
            </div>
          </div>
          <div class="scene-panel hidden" id="scenePanel">
            <div class="panel-head">Scenes
              <div class="panel-actions">
                <button id="scenePanelClose" class="mini-btn">Close</button>
              </div>
            </div>
            <ul id="sceneList"></ul>
            <div class="panel-actions" style="margin-top:8px">
              <button id="sceneDeleteAllBtn" class="mini-btn danger">Delete All</button>
            </div>
          </div>
        </div>
        <p class="map-hint">Drag tokens. Walls mode to draw barriers. Vision Auto reveals based on token radius (right‚Äëclick token ‚Üí Set Vision). Ruler (M) to measure. Export to save board JSON.</p>
      </section>

  <!-- entities replaces compendium -->

      <section id="view-about" class="view prose">
        <h1>About</h1>
        <p>This dashboard pulls live data from a Google Sheet you control. Edit the sheet, refresh here, done.</p>
        <ol>
          <li>Open your sheet in Google Sheets.</li>
          <li>File ‚Üí Share ‚Üí Publish to web ‚Üí Select the tab ‚Üí CSV ‚Üí Publish.</li>
          <li>Copy the generated URL and paste it into <code>config.js</code> (GOOGLE_SHEET_CSV_URL).</li>
          <li>Reload this page.</li>
        </ol>
        <p>Use search, filters, board view, and quick export. Data never leaves your browser.</p>
      </section>

      <footer class="footer">Live sheet sync ‚Ä¢ <span id="recordCount">0</span> rows ‚Ä¢ <span id="lastUpdated">‚Äî</span></footer>
  <section id="view-character" class="view">
        <div class="char-page">
          <div class="char-header">
            <div class="char-img-wrap" id="charImgWrap" title="Click to set image">
              <img id="charImg" alt="Character" class="hidden" />
              <div class="char-img-placeholder" id="charImgPh">IMG</div>
              <input type="file" id="charImgInput" accept="image/*" hidden />
            </div>
            <div class="char-main-info">
              <input id="charName" class="char-name" placeholder="Character Name" />
              <div class="char-basic-info">
                <input id="charClass" placeholder="Class" />
                <input id="charLevel" type="number" placeholder="Level" min="1" max="20" value="1" />
                <input id="charRace" placeholder="Race" />
                <input id="charBackground" placeholder="Background" />
              </div>
            </div>
            <div class="char-actions">
              <button id="saveCharacterBtn" class="accent-btn">Save Character</button>
              <button id="exportCharacterBtn" class="mini-btn">Export JSON</button>
            </div>
          </div>

          <div class="char-abilities">
            <h3>Ability Scores</h3>
            <div class="abilities-grid">
              <div class="ability-score">
                <label>STR</label>
                <input id="charStr" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="strMod">+0</div>
              </div>
              <div class="ability-score">
                <label>DEX</label>
                <input id="charDex" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="dexMod">+0</div>
              </div>
              <div class="ability-score">
                <label>CON</label>
                <input id="charCon" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="conMod">+0</div>
              </div>
              <div class="ability-score">
                <label>INT</label>
                <input id="charInt" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="intMod">+0</div>
              </div>
              <div class="ability-score">
                <label>WIS</label>
                <input id="charWis" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="wisMod">+0</div>
              </div>
              <div class="ability-score">
                <label>CHA</label>
                <input id="charCha" type="number" min="1" max="30" value="10" />
                <div class="modifier" id="chaMod">+0</div>
              </div>
            </div>
          </div>

          <div class="char-combat-stats">
            <h3>Combat Stats</h3>
            <div class="combat-grid">
              <div class="stat-block">
                <label>Armor Class</label>
                <input id="charAC" type="number" min="1" max="30" value="10" />
              </div>
              <div class="stat-block">
                <label>Hit Points</label>
                <input id="charHP" type="number" min="1" max="999" />
              </div>
              <div class="stat-block">
                <label>Max HP</label>
                <input id="charMaxHP" type="number" min="1" max="999" />
              </div>
              <div class="stat-block">
                <label>Speed</label>
                <input id="charSpeed" placeholder="30 ft" />
              </div>
              <div class="stat-block">
                <label>Proficiency Bonus</label>
                <input id="charProfBonus" type="number" value="2" readonly />
              </div>
            </div>
          </div>

          <div class="char-skills">
            <h3>Skills & Saves</h3>
            <div class="skills-grid">
              <div class="skill-section">
                <h4>Saving Throws</h4>
                <label><input type="checkbox" id="strSaveProf"> Strength <span id="strSave">+0</span></label>
                <label><input type="checkbox" id="dexSaveProf"> Dexterity <span id="dexSave">+0</span></label>
                <label><input type="checkbox" id="conSaveProf"> Constitution <span id="conSave">+0</span></label>
                <label><input type="checkbox" id="intSaveProf"> Intelligence <span id="intSave">+0</span></label>
                <label><input type="checkbox" id="wisSaveProf"> Wisdom <span id="wisSave">+0</span></label>
                <label><input type="checkbox" id="chaSaveProf"> Charisma <span id="chaSave">+0</span></label>
              </div>
              <div class="skill-section">
                <h4>Skills</h4>
                <div class="skills-list" id="skillsList"></div>
              </div>
            </div>
          </div>

          <div class="char-features">
            <h3>Features & Traits</h3>
            <textarea id="charFeatures" placeholder="Class features, racial traits, background features, etc."></textarea>
          </div>

          <div class="char-inv card-panel">
            <h3>Equipment & Inventory</h3>
            <div class="inv-sections">
              <div class="inv-block"><label>Weapons</label><textarea id="invWeapons" placeholder="Longsword, Shortbow, etc."></textarea></div>
              <div class="inv-block"><label>Armor & Shield</label><textarea id="invArmor" placeholder="Chain mail, Shield, etc."></textarea></div>
              <div class="inv-block wide"><label>Other Equipment</label><textarea id="invOther" placeholder="Backpack, rope, torches, etc."></textarea></div>
            </div>
          </div>

          <div class="char-moves card-panel">
            <div class="char-moves-head">
              <h3>Spells & Abilities</h3>
              <input type="search" id="charMoveFilter" placeholder="Filter assigned" />
              <input type="search" id="charMoveAdd" placeholder="Add spell/ability by name" />
            </div>
            <div id="charMoveSuggestions" class="char-suggestions hidden"></div>
            <div id="charMovesList" class="char-move-list"></div>
          </div>

          <div class="char-backstory">
            <h3>Character Backstory</h3>
            <textarea id="charBackstory" placeholder="Character's background story, personality traits, ideals, bonds, and flaws..."></textarea>
          </div>
        </div>
      </section>
    </main>
  </div>
  <button id="helpFab" class="help-fab" title="Help">?</button>
  <div id="sheetModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel">
      <header><h2>Sheet Source</h2><button id="closeSheetModal" class="close-btn" aria-label="Close">√ó</button></header>
      <p>Paste the Published CSV URL from Google Sheets. (File ‚Üí Share ‚Üí Publish to web ‚Üí CSV)</p>
      <textarea id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"></textarea>
      <div class="actions">
        <button id="saveSheetUrl" class="accent-btn">Save & Reload</button>
        <button id="clearSheetUrl" class="mini-btn">Clear Override</button>
  <button id="modalUploadBtn" class="mini-btn" type="button">Upload Local File‚Ä¶</button>
      </div>
      <small>Stored locally in your browser. Share the link hash like <code>#sheet=&lt;url&gt;</code> to preload.</small>
    </div>
  </div>
  <div id="editorModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel edit-panel">
      <header><h2 id="editTitle">Edit Row</h2><button id="closeEditorModal" class="close-btn" aria-label="Close">√ó</button></header>
      <form id="editForm"></form>
      <div class="actions">
        <button id="saveRowBtn" class="accent-btn" type="button">Save</button>
        <button id="deleteRowBtn" class="mini-btn danger" type="button">Delete</button>
      </div>
    </div>
  </div>
  <!-- Landing: Table selection (DnDex) -->
  <div id="welcomeModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-panel" style="max-width:520px">
      <header><h2>Welcome to DnDex</h2></header>
      <div class="welcome-simple">
          <label>Your Name<input id="wlName" placeholder="GM or Player" /></label>
          <div class="wl-row">
            <button id="wlCreate" class="accent-btn" style="flex:1">Host (GM)</button>
            <button id="wlSolo" class="mini-btn" style="flex:0 0 auto">Solo</button>
          </div>
          <div class="join-block">
            <label>Join Code<input id="wlInvite" placeholder="Enter code (e.g. abcd12)" /></label>
            <button id="wlJoin" class="mini-btn" style="width:100%">Join Game</button>
          </div>
          <div id="hostCodeDisplay" class="host-code" aria-live="polite" style="display:none"></div>
          <small class="muted">Share only the code. Players paste it and press Join.</small>
      </div>
    </div>
  </div>
  
  <!-- Image Cropping Modal -->
  <div id="imageCropperModal" class="image-cropper-modal hidden">
    <div class="image-cropper-content">
      <h3>Crop Character Image</h3>
      <div class="crop-instructions">
        Drag the selection area to choose the portion of the image for your character profile. 
        Use the corner and edge handles to resize the selection area.
      </div>
      <div class="crop-container" id="cropContainer">
        <img id="cropImage" />
        <div class="crop-overlay" id="cropOverlay" onmousedown="startDrag(event)">
          <div class="crop-handles">
            <div class="crop-handle nw" onmousedown="startDrag(event)"></div>
            <div class="crop-handle n" onmousedown="startDrag(event)"></div>
            <div class="crop-handle ne" onmousedown="startDrag(event)"></div>
            <div class="crop-handle w" onmousedown="startDrag(event)"></div>
            <div class="crop-handle e" onmousedown="startDrag(event)"></div>
            <div class="crop-handle sw" onmousedown="startDrag(event)"></div>
            <div class="crop-handle s" onmousedown="startDrag(event)"></div>
            <div class="crop-handle se" onmousedown="startDrag(event)"></div>
          </div>
        </div>
      </div>
      <div class="crop-preview">
        <div style="color: var(--text-dim); font-size: 12px; margin-bottom: 8px;">Preview:</div>
        <img id="cropPreviewImg" class="crop-preview-img" alt="Crop preview">
      </div>
      <div class="crop-actions">
        <button id="cropCancel" class="mini-btn">Cancel</button>
        <button id="cropApply" class="accent-btn">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- Character Image Context Menu -->
  <div id="imageContextMenu" class="context-menu hidden">
    <div class="context-menu-item" onclick="changeCharacterImage()">
      <span>üìÅ</span> Change Picture
    </div>
    <div class="context-menu-item" onclick="resizeCharacterImage()">
      <span>‚úÇÔ∏è</span> Resize Picture
    </div>
    <div class="context-menu-item" onclick="deleteCharacterImage()">
      <span>üóëÔ∏è</span> Delete Image
    </div>
  </div>
  
  <script src="js/config.js"></script>
  <script src="js/persist.js"></script>
  <script src="js/sheet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Firebase (optional, used when 'Use Firebase' is enabled) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/compendium.js"></script>
  <script>if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{})); }</script>
</body>
</html>
