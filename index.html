<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DnDex</title>
  <base href="./">
  <meta name="description" content="DnDex ‚Äî simple, collaborative VTT and organizer with scenes, fog, walls, and live cursors." />
  <meta name="theme-color" content="#0d0f11" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%234f8dff'/%3E%3Ctext x='50' y='60' font-size='56' text-anchor='middle' fill='white' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app" class="app-shell">
    <aside class="sidebar" id="sidebar">
  <div class="brand">DnDex</div>
      <nav class="nav">
        <button class="nav-btn active" data-view="moves">Moves</button>
        <button class="nav-btn" data-view="items">Items</button>
        <button class="nav-btn" data-view="events">Events</button>
        <button class="nav-btn" data-view="conditions">Conditions</button>
        <button class="nav-btn" data-view="entities">Entities</button>
        <button class="nav-btn" data-view="items-entities-info">Items & Entities</button>
        <button class="nav-btn" data-view="character-database">Character Database</button>
        <button class="nav-btn" data-view="board">Kanban</button>
        <button class="nav-btn" data-view="table">Table</button>
        <button class="nav-btn" data-view="character">Character</button>
        <button class="nav-btn" data-view="profile">Profile</button>
        <button class="nav-btn" data-view="about">About</button>
      </nav>
      <div class="sidebar-footer">
        <button id="refreshBtn" class="accent-btn" title="Reload data">‚Üª Refresh</button>
        <label class="toggle tiny">
          <input type="checkbox" id="autoRefreshToggle" checked>
          <span>Auto</span>
        </label>
      </div>
    </aside>
    <main class="main">
      <header class="topbar">
        <div class="breadcrumbs" id="statusLine">Loading‚Ä¶</div>
  <div class="spacer"></div>
  <label class="toggle hide-on-map hidden" title="Lean mode"><input type="checkbox" id="leanToggle" /> <span>Lean</span></label>
  <button id="sheetConfigBtn" class="mini-btn hide-on-map" title="Configure sheet">‚öôÔ∏è</button>
  <button id="uploadBtn" class="mini-btn hide-on-map" title="Upload local Excel/CSV">Upload</button>
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none" />
  <a class="mini-btn hide-on-map" id="templateLink" href="assets/template.csv" download>Template</a>
  <button id="sampleDataBtn" class="mini-btn hide-on-map" title="Insert sample data">Sample</button>
    <input type="search" id="search" class="hide-on-map" placeholder="Search‚Ä¶" autocomplete="off" />
  <button id="adminToggle" class="mini-btn hide-on-map hidden" title="Toggle admin editing">Admin Off</button>
  <button id="resetAppBtn" class="mini-btn danger hide-on-map hidden" title="Reset app (clears local data)">Reset</button>
        <button id="themeSwitch" title="Toggle theme">üåô</button>
      </header>

  <section id="view-table" class="view">
        <div class="toolbar">
          <div class="left-tools">
            <select id="columnFilter"></select>
            <select id="valueFilter"></select>
          </div>
          <div class="right-tools">
            <button id="exportJson" class="mini-btn">Export JSON</button>
            <button id="exportCsv" class="mini-btn">Export CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-moves" class="view active">
        <div class="moves-layout">
          <div class="moves-editor card-panel" id="movesEditorPanel">
            <h2 class="panel-title">Create / Edit Move</h2>
            <form id="moveForm" autocomplete="off">
              <div class="form-row">
                <label>Name<input name="name" required placeholder="Fireball" /></label>
              </div>
              
              <div class="form-row">
                <label>Category
                  <select name="category">
                    <option value="">Select category...</option>
                    <option value="attack">Attack</option>
                    <option value="spell">Spell</option>
                    <option value="utility">Utility</option>
                    <option value="defense">Defense</option>
                    <option value="movement">Movement</option>
                    <option value="social">Social</option>
                    <option value="other">Other</option>
                  </select>
                </label>
              </div>
              
              <div class="form-row">
                <label>Description<textarea name="description" placeholder="Area explosion dealing 8d6 fire damage to all creatures in a 20-foot radius"></textarea></label>
              </div>
              
              <div class="form-row two-col">
                <label>Damage/Effect<input name="damage" placeholder="8d6 fire" /></label>
                <label>Range<input name="range" placeholder="150 feet" /></label>
              </div>
              
              <div class="form-row">
                <label>Tags (comma separated)<input name="tags" placeholder="fire, area, damage, spell" /></label>
              </div>
              
              <div class="form-row">
                <label>Image Upload
                  <input type="file" name="imageFile" accept="image/*" class="file-input" />
                  <div class="image-preview-container hidden" id="imagePreviewContainer">
                    <img id="imagePreview" class="image-preview" />
                    <button type="button" class="mini-btn" id="removeImage">Remove Image</button>
                  </div>
                </label>
              </div>
              
              <div class="form-actions">
                <button type="button" id="addMoveBtn" class="accent-btn">Save Move</button>
                <button type="button" id="resetMoveBtn" class="mini-btn">Clear</button>
                <button type="button" id="exportMovesBtn" class="mini-btn">Export</button>
                <button type="button" id="importMovesBtn" class="mini-btn">Import</button>
                <input type="file" id="importMovesInput" accept=".xlsx,.xls" style="display:none" />
              </div>
            </form>
          </div>
          <div class="moves-list card-panel">
            <div class="moves-toolbar">
              <input type="search" id="moveSearch" placeholder="Search moves by name, category, or tag..." />
              <select id="categoryFilter" class="mini-select">
                <option value="">All Categories</option>
                <option value="attack">Attack</option>
                <option value="spell">Spell</option>
                <option value="utility">Utility</option>
                <option value="defense">Defense</option>
                <option value="movement">Movement</option>
                <option value="social">Social</option>
                <option value="other">Other</option>
              </select>
            </div>
            <table id="movesTable" class="moves-table">
              <thead><tr><th>Name</th><th>Category</th><th>Description</th><th>Damage/Range</th><th>Tags</th><th class="actions-col">Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="movesEmpty" class="empty-hint hidden">
              <div class="empty-content">
                <h3>No moves yet</h3>
                <p>Create your first move using the form on the left.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-items" class="view">
        <div class="entities-header">
          <h2>Items & Equipment</h2>
          <div class="entities-actions">
            <button id="addItemBtn" class="primary-btn">Add New Item</button>
            <button id="importItemsBtn" class="secondary-btn">Import Excel</button>
            <button id="exportItemsBtn" class="secondary-btn">Export Excel</button>
          </div>
        </div>
        
        <div class="entities-filters">
          <div class="search-section">
            <input type="search" id="itemSearch" placeholder="Search items by name or tags..." />
            <button id="clearItemSearchBtn" class="mini-btn">Clear</button>
          </div>
          
          <div class="filter-section" id="itemTagFilters">
            <!-- Tag filters will be dynamically generated here -->
          </div>
          
          <div class="sort-section">
            <label>Sort by:
              <select id="sortItemsSelect">
                <option value="name">Name</option>
                <option value="created">Date Added</option>
              </select>
            </label>
          </div>
        </div>
        
        <div id="itemsGrid" class="entities-grid"></div>
        
        <!-- Item Detail Modal -->
        <div id="itemModal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="itemModalTitle">Item Details</h3>
              <button id="closeItemModal" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <form id="itemForm">
                <div class="form-grid">
                  <div class="form-group full-width">
                    <label for="itemName">Name *</label>
                    <input type="text" id="itemName" required />
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="itemDescription">Description</label>
                    <textarea id="itemDescription" rows="4" placeholder="Describe the item's appearance, properties, and effects..."></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="itemTags">Tags</label>
                    <input type="text" id="itemTags" placeholder="magic, rare, combat (comma separated)" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="itemImage">Img link</label>
                    <input type="url" id="itemImage" placeholder="https://example.com/image.jpg" />
                  </div>
                </div>
                
                <div class="modal-actions">
                  <button type="button" id="cancelItemBtn" class="secondary-btn">Cancel</button>
                  <button type="submit" id="saveItemBtn" class="primary-btn">Save Item</button>
                  <button type="button" id="deleteItemBtn" class="danger-btn hidden">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-events" class="view">
        <div class="entities-header">
          <h2>Events & Encounters</h2>
          <div class="entities-actions">
            <button id="addEventBtn" class="primary-btn">Add New Event</button>
            <button id="importEventsBtn" class="secondary-btn">Import Excel</button>
            <button id="exportEventsBtn" class="secondary-btn">Export Excel</button>
          </div>
        </div>
        
        <div class="entities-filters">
          <div class="search-section">
            <input type="search" id="eventSearch" placeholder="Search events by name, type, or tags..." />
            <button id="clearEventSearchBtn" class="mini-btn">Clear</button>
          </div>
          
          <div class="filter-section">
            <label><input type="checkbox" id="showCombatEvents" checked /> Combat</label>
            <label><input type="checkbox" id="showSocialEvents" checked /> Social</label>
            <label><input type="checkbox" id="showExplorationEvents" checked /> Exploration</label>
            <label><input type="checkbox" id="showPuzzleEvents" checked /> Puzzle</label>
            <label><input type="checkbox" id="showStoryEvents" checked /> Story</label>
            <label><input type="checkbox" id="showRandomEvents" checked /> Random</label>
          </div>
          
          <div class="sort-section">
            <label>Sort by:
              <select id="sortEventsSelect">
                <option value="name">Name</option>
                <option value="type">Type</option>
                <option value="difficulty">Difficulty</option>
                <option value="created">Date Added</option>
              </select>
            </label>
          </div>
        </div>
        
        <div id="eventsGrid" class="entities-grid"></div>
        
        <!-- Event Detail Modal -->
        <div id="eventModal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="eventModalTitle">Event Details</h3>
              <button id="closeEventModal" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <form id="eventForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="eventName">Name *</label>
                    <input type="text" id="eventName" required />
                  </div>
                  
                  <div class="form-group">
                    <label for="eventType">Type *</label>
                    <select id="eventType" required>
                      <option value="">Select Type</option>
                      <option value="combat">Combat</option>
                      <option value="social">Social</option>
                      <option value="exploration">Exploration</option>
                      <option value="puzzle">Puzzle</option>
                      <option value="story">Story</option>
                      <option value="random">Random</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="eventDifficulty">Difficulty</label>
                    <select id="eventDifficulty">
                      <option value="trivial">Trivial</option>
                      <option value="easy">Easy</option>
                      <option value="moderate">Moderate</option>
                      <option value="hard">Hard</option>
                      <option value="deadly">Deadly</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="eventDuration">Duration</label>
                    <input type="text" id="eventDuration" placeholder="1 hour, 10 minutes, etc." />
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="eventDescription">Description</label>
                    <textarea id="eventDescription" rows="4" placeholder="Describe what happens in this event..."></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="eventSetup">Setup & Preparation</label>
                    <textarea id="eventSetup" rows="3" placeholder="What needs to be prepared for this event..."></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="eventTags">Tags</label>
                    <input type="text" id="eventTags" placeholder="boss, dungeon, roleplay (comma separated)" />
                  </div>
                  
                  <div class="form-group">
                    <label for="eventRewards">Rewards</label>
                    <input type="text" id="eventRewards" placeholder="XP, gold, items, etc." />
                  </div>
                </div>
                
                <div class="modal-actions">
                  <button type="button" id="cancelEventBtn" class="secondary-btn">Cancel</button>
                  <button type="submit" id="saveEventBtn" class="primary-btn">Save Event</button>
                  <button type="button" id="deleteEventBtn" class="danger-btn hidden">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-conditions" class="view">
        <div class="entities-header">
          <h2>Conditions & Effects</h2>
          <div class="entities-actions">
            <button id="addConditionBtn" class="primary-btn">Add New Condition</button>
            <button id="importConditionsBtn" class="secondary-btn">Import Excel</button>
            <button id="exportConditionsBtn" class="secondary-btn">Export Excel</button>
          </div>
        </div>
        
        <div class="entities-filters">
          <div class="search-section">
            <input type="search" id="conditionSearch" placeholder="Search conditions by name, type, or effects..." />
            <button id="clearConditionSearchBtn" class="mini-btn">Clear</button>
          </div>
          
          <div class="filter-section">
            <label><input type="checkbox" id="showDebuffConditions" checked /> Debuffs</label>
            <label><input type="checkbox" id="showBuffConditions" checked /> Buffs</label>
            <label><input type="checkbox" id="showStatusConditions" checked /> Status</label>
            <label><input type="checkbox" id="showMagicalConditions" checked /> Magical</label>
            <label><input type="checkbox" id="showPhysicalConditions" checked /> Physical</label>
            <label><input type="checkbox" id="showOtherConditions" checked /> Other</label>
          </div>
          
          <div class="sort-section">
            <label>Sort by:
              <select id="sortConditionsSelect">
                <option value="name">Name</option>
                <option value="type">Type</option>
                <option value="severity">Severity</option>
                <option value="created">Date Added</option>
              </select>
            </label>
          </div>
        </div>
        
        <div id="conditionsGrid" class="entities-grid"></div>
        
        <!-- Condition Detail Modal -->
        <div id="conditionModal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="conditionModalTitle">Condition Details</h3>
              <button id="closeConditionModal" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <form id="conditionForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="conditionName">Name *</label>
                    <input type="text" id="conditionName" required />
                  </div>
                  
                  <div class="form-group">
                    <label for="conditionType">Type *</label>
                    <select id="conditionType" required>
                      <option value="">Select Type</option>
                      <option value="debuff">Debuff</option>
                      <option value="buff">Buff</option>
                      <option value="status">Status</option>
                      <option value="magical">Magical</option>
                      <option value="physical">Physical</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="conditionSeverity">Severity</label>
                    <select id="conditionSeverity">
                      <option value="minor">Minor</option>
                      <option value="moderate">Moderate</option>
                      <option value="major">Major</option>
                      <option value="severe">Severe</option>
                      <option value="critical">Critical</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="conditionDuration">Duration</label>
                    <input type="text" id="conditionDuration" placeholder="1 round, 1 minute, until healed, etc." />
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="conditionDescription">Description</label>
                    <textarea id="conditionDescription" rows="4" placeholder="Describe what this condition does..."></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="conditionEffects">Game Effects</label>
                    <textarea id="conditionEffects" rows="3" placeholder="Mechanical effects (disadvantage on attacks, -2 to AC, etc.)"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="conditionTags">Tags</label>
                    <input type="text" id="conditionTags" placeholder="poison, charm, fear (comma separated)" />
                  </div>
                  
                  <div class="form-group">
                    <label for="conditionRemoval">How to Remove</label>
                    <input type="text" id="conditionRemoval" placeholder="Lesser restoration, long rest, etc." />
                  </div>
                </div>
                
                <div class="modal-actions">
                  <button type="button" id="cancelConditionBtn" class="secondary-btn">Cancel</button>
                  <button type="submit" id="saveConditionBtn" class="primary-btn">Save Condition</button>
                  <button type="button" id="deleteConditionBtn" class="danger-btn hidden">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-entities" class="view">
        <div class="entities-header">
          <h2>Items & Entities</h2>
          <div class="entities-actions">
            <button id="addEntityBtn" class="primary-btn">Add New Item</button>
            <button id="importExcelBtn" class="secondary-btn">Import Excel</button>
            <button id="exportExcelBtn" class="secondary-btn">Export Excel</button>
          </div>
        </div>
        
        <div class="entities-filters">
          <div class="search-section">
            <input type="search" id="entitySearch" placeholder="Search items by name, type, or tags..." />
            <button id="clearSearchBtn" class="mini-btn">Clear</button>
          </div>
          
          <div class="filter-section">
            <label><input type="checkbox" id="showWeapons" checked /> Weapons</label>
            <label><input type="checkbox" id="showArmor" checked /> Armor</label>
            <label><input type="checkbox" id="showItems" checked /> Items</label>
            <label><input type="checkbox" id="showMagic" checked /> Magic Items</label>
            <label><input type="checkbox" id="showOther" checked /> Other</label>
          </div>
          
          <div class="sort-section">
            <label>Sort by:
              <select id="sortBySelect">
                <option value="name">Name</option>
                <option value="type">Type</option>
                <option value="created">Date Added</option>
              </select>
            </label>
          </div>
        </div>
        
        <div id="entitiesGrid" class="entities-grid"></div>
        
        <!-- Entity Detail Modal -->
        <div id="entityModal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="entityModalTitle">Item Details</h3>
              <button id="closeEntityModal" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <form id="entityForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="entityName">Name *</label>
                    <input type="text" id="entityName" required />
                  </div>
                  
                  <div class="form-group">
                    <label for="entityType">Type *</label>
                    <select id="entityType" required>
                      <option value="">Select Type</option>
                      <option value="weapon">Weapon</option>
                      <option value="armor">Armor</option>
                      <option value="potion">Potion</option>
                      <option value="scroll">Scroll</option>
                      <option value="wondrous">Wondrous Item</option>
                      <option value="tool">Tool</option>
                      <option value="treasure">Treasure</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="entityDescription">Description</label>
                    <textarea id="entityDescription" rows="4" placeholder="Describe the item's appearance, properties, and effects..."></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="entityTags">Tags</label>
                    <input type="text" id="entityTags" placeholder="magic, rare, combat (comma separated)" />
                  </div>
                  
                  <div class="form-group">
                    <label for="entityValue">Value (gp)</label>
                    <input type="number" id="entityValue" min="0" step="0.01" />
                  </div>
                  
                  <div class="form-group">
                    <label for="entityWeight">Weight (lbs)</label>
                    <input type="number" id="entityWeight" min="0" step="0.1" />
                  </div>
                  
                  <div class="form-group">
                    <label for="entityRarity">Rarity</label>
                    <select id="entityRarity">
                      <option value="common">Common</option>
                      <option value="uncommon">Uncommon</option>
                      <option value="rare">Rare</option>
                      <option value="very-rare">Very Rare</option>
                      <option value="legendary">Legendary</option>
                      <option value="artifact">Artifact</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label for="entityImage">Image URL</label>
                    <input type="url" id="entityImage" placeholder="https://example.com/image.jpg" />
                  </div>
                </div>
                
                <div class="modal-actions">
                  <button type="button" id="cancelEntityBtn" class="secondary-btn">Cancel</button>
                  <button type="submit" id="saveEntityBtn" class="primary-btn">Save Item</button>
                  <button type="button" id="deleteEntityBtn" class="danger-btn hidden">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-board" class="view">
        <div class="board-toolbar">
          <label>Group by <select id="groupSelect"></select></label>
          <button id="addCardBtn" class="mini-btn">New Card</button>
        </div>
  <div id="boardSummary" class="board-summary"></div>
        <div id="kanban" class="kanban"></div>
        <div id="kanbanEmpty" class="empty-hint hidden">No cards to show. Load data or add a new card.</div>
      </section>

      <section id="view-map" class="view">
        <div class="map-toolbar compact">
          <div class="map-left">
            <button id="addSingleTokenBtn" class="mini-btn">Add Token</button>
            <button id="wallModeBtn" class="mini-btn">Walls</button>
            <button id="fogRevealBtn" class="mini-btn">Reveal</button>
            <button id="rulerBtn" class="mini-btn">Ruler</button>
            <button id="fogFullBtn" class="mini-btn">Cover All</button>
            <button id="fogClearBtn" class="mini-btn">Clear All</button>
          </div>
          <div class="map-right">
            <label>Grid <input type="number" id="gridSizeInput" value="50" min="20" max="120" step="5" style="width:70px" /></label>
            <label>Snap <input type="checkbox" id="snapToggle" checked /></label>
            <button id="exportImageBtn" class="mini-btn" title="Export PNG">PNG</button>
            <label class="toggle"><input type="checkbox" id="visionAutoToggle" checked/> <span>Vision</span></label>
            <button id="mapMoreBtn" class="mini-btn">More‚Ä¶</button>
          </div>
        </div>
        <div id="mapMorePanel" class="map-more hidden">
          <div class="more-row">
            <!-- Moved fog buttons to main toolbar for better accessibility -->
            <label class="toggle"><input type="checkbox" id="cursorsToggle" checked /> <span>Cursors</span></label>
          </div>
          <div class="more-row">
            <div class="fog-adv-group">
              <label>Brush <input type="range" id="fogBrushSize" min="20" max="200" value="90"></label>
              <select id="fogBrushShape"><option value="circle">Circle</option><option value="rect">Square</option></select>
              <button id="fogUndoBtn" class="mini-btn" title="Undo fog step">Undo</button>
            </div>
            <button id="bgImageBtn" class="mini-btn" title="Set background image">BG Img</button>
            <input type="file" id="bgImageInput" accept="image/*" style="display:none" />
          </div>
          <div class="more-row">
            <div class="scenes-group">
              <label>Scene <select id="sceneSelect"></select></label>
              <button id="sceneSaveBtn" class="mini-btn" title="Save current as scene">Save</button>
              <button id="sceneLoadBtn" class="mini-btn" title="Load selected scene">Load</button>
              <button id="sceneManageBtn" class="mini-btn" title="Manage scenes">Manage</button>
            </div>
            <div class="layer-toggles">
              <label><input type="checkbox" id="showFogToggle" checked /> Fog</label>
              <label><input type="checkbox" id="showWallsToggle" checked /> Walls</label>
              <label><input type="checkbox" id="showTemplatesToggle" checked /> Templates</label>
            </div>
            <button id="clearWallsBtn" class="mini-btn" title="Delete all walls">Clear Walls</button>
            <button id="clearTemplatesBtn" class="mini-btn" title="Delete all templates">Clear Templates</button>
          </div>
        </div>
  <div id="sessionBanner" class="session-banner" aria-live="polite"></div>
  <div id="mapStage" class="map-stage">
          <canvas id="battleMap" width="1200" height="800"></canvas>
          <div class="token-layer" id="tokenLayer"></div>
          <canvas class="walls-layer" id="wallsCanvas" width="1200" height="800"></canvas>
          <canvas class="fog-layer" id="fogCanvas" width="1200" height="800"></canvas>
          <canvas class="overlay-layer" id="overlayCanvas" width="1200" height="800"></canvas>
          <div class="cursor-layer" id="cursorLayer" aria-hidden="true"></div>
        </div>
  <div id="toast" class="toast hidden"></div>

        <!-- Multiplayer modal -->
        <div id="mpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2>Multiplayer</h2><button id="closeMpModal" class="close-btn" aria-label="Close">√ó</button></header>
            <div class="form-grid">
              <label>Server URL<input id="mpServerUrl" placeholder="wss://your-relay.example.com" /></label>
              <label>Room Code<input id="mpRoomCode" placeholder="my-room-123" /></label>
              <label>Your Name<input id="mpName" placeholder="Player" /></label>
              <div class="row-btns">
                <button id="mpDoHost" class="accent-btn">Host as GM</button>
                <button id="mpDoJoin" class="mini-btn">Join</button>
              </div>
              <small>Tip: As GM, start the server locally and click Host. Share Room Code and your Server URL to players.</small>
              <hr />
              <label class="toggle"><input type="checkbox" id="mpUseFirebase" /> <span>Use Firebase (no server)</span></label>
              <label>Firebase Config (JSON)
                <textarea id="mpFirebaseConfig" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"https://<project>.firebaseio.com","projectId":"..."}'></textarea>
              </label>
              <div class="row-btns">
                <button id="mpSaveFirebase" class="mini-btn">Save Firebase</button>
              </div>
              <small>Paste Realtime Database web config from your Firebase project. This avoids running a relay.</small>
            </div>
          </div>
        </div>

  <div id="mapHelpModal" class="modal hidden" role="dialog" aria-modal="true">
          <div class="modal-panel">
            <header><h2 id="helpTitle">Quick Help</h2><button id="closeMapHelp" class="close-btn" aria-label="Close">√ó</button></header>
            <div id="helpContent"></div>
          </div>
        </div>
        <div class="map-panels">
          <div class="initiative-panel" id="initiativePanel">
            <div class="panel-head">Initiative
              <div class="panel-actions">
                <button id="initAddBtn" class="mini-btn">Add Sel</button>
                <button id="initPrevBtn" class="mini-btn">‚óÄ</button>
                <button id="initNextBtn" class="mini-btn">‚ñ∂</button>
                <button id="initClearBtn" class="mini-btn">Clear</button>
              </div>
            </div>
            <ol id="initiativeList"></ol>
          </div>
          <div class="token-panel" id="tokenInspector">
            <div class="panel-head">Token Inspector</div>
            <div class="tp-body">
              <label>Name<input id="tiName" placeholder="token name" /></label>
              <label>Type
                <select id="tiType">
                  <option value="">Neutral</option>
                  <option value="player">Player</option>
                  <option value="enemy">Enemy</option>
                </select>
              </label>
              <label>HP<input id="tiHP" type="number" min="0" step="1" placeholder="" /></label>
              <label>Vision (px)<input id="tiVision" type="number" min="0" step="10" placeholder="180" /></label>
            </div>
          </div>
          <div class="scene-panel hidden" id="scenePanel">
            <div class="panel-head">Scenes
              <div class="panel-actions">
                <button id="scenePanelClose" class="mini-btn">Close</button>
              </div>
            </div>
            <ul id="sceneList"></ul>
            <div class="panel-actions" style="margin-top:8px">
              <button id="sceneDeleteAllBtn" class="mini-btn danger">Delete All</button>
            </div>
          </div>
        </div>
        <p class="map-hint">Drag tokens. Walls mode to draw barriers. Vision Auto reveals based on token radius (right‚Äëclick token ‚Üí Set Vision). Ruler (M) to measure. Export to save board JSON.</p>
      </section>

  <!-- entities replaces compendium -->

      <section id="view-about" class="view prose">
        <h1>About</h1>
        <p>This dashboard pulls live data from a Google Sheet you control. Edit the sheet, refresh here, done.</p>
        <ol>
          <li>Open your sheet in Google Sheets.</li>
          <li>File ‚Üí Share ‚Üí Publish to web ‚Üí Select the tab ‚Üí CSV ‚Üí Publish.</li>
          <li>Copy the generated URL and paste it into <code>config.js</code> (GOOGLE_SHEET_CSV_URL).</li>
          <li>Reload this page.</li>
        </ol>
        <p>Use search, filters, board view, and quick export. Data never leaves your browser.</p>
      </section>

      <!-- Items & Entities Information View -->
      <section id="view-items-entities-info" class="view">
        <div class="info-header">
          <h1>Items & Entities Information</h1>
          <p>Data from Google Spreadsheet - "Items" sheet</p>
          <button id="refreshInfoBtn" class="secondary-btn">üîÑ Refresh Data</button>
        </div>
        
        <div class="info-filters">
          <input type="search" id="infoSearch" placeholder="Search by name..." />
          <select id="infoSortSelect">
            <option value="name">Sort by Name</option>
            <option value="original">Original Order</option>
          </select>
        </div>

        <div class="info-table-container">
          <table id="infoTable" class="data-table">
            <thead id="infoTableHead"></thead>
            <tbody id="infoTableBody"></tbody>
          </table>
          <div id="infoEmptyState" class="empty-state" style="display: none;">
            <h3>No data available</h3>
            <p>Make sure your Google Spreadsheet has an "Items" sheet and is properly configured.</p>
          </div>
        </div>
      </section>

      <!-- Character Database View -->
      <section id="view-character-database" class="view">
        <div class="char-db-header">
          <div>
            <h1>Character Database</h1>
            <p>Data from Google Spreadsheet - "PJ" sheet</p>
          </div>
          <button id="refreshCharDbBtn" class="secondary-btn">üîÑ Refresh Data</button>
        </div>
        
        <div class="char-db-filters">
          <input type="search" id="charDbSearch" placeholder="Search characters..." />
          
          <div class="filter-group">
            <label>Filter by Tags:</label>
            <div id="charDbTagFilters" class="filter-checkboxes"></div>
          </div>
          
          <div class="filter-group">
            <label>Filter by Moves:</label>
            <div id="charDbMoveFilters" class="filter-checkboxes"></div>
          </div>
          
          <div class="sort-group">
            <label>Sort by:</label>
            <select id="charDbSortSelect">
              <option value="original">Original Order</option>
              <option value="name">Name</option>
              <option value="hp">HP</option>
              <option value="vel">VEL</option>
            </select>
          </div>
        </div>

        <div class="char-db-grid" id="charDbGrid">
          <!-- Character cards will be dynamically inserted here -->
        </div>
        
        <div id="charDbEmptyState" class="empty-state" style="display: none;">
          <h3>No characters found</h3>
          <p>Make sure your Google Spreadsheet has a "PJ" sheet and is properly configured.</p>
        </div>
      </section>

      <!-- Profile View -->
      <section id="view-profile" class="view">
        <div class="profile-container">
          <div class="profile-header">
            <h1>Profile & Account Management</h1>
            <p>Manage your characters, settings, and data across devices</p>
          </div>

          <!-- Profile Creation/Login -->
          <div id="profileAuthSection" class="card-panel">
            <h2>Create Account or Sign In</h2>
            <div class="profile-auth-form">
              <div class="form-group">
                <label for="profileName">Display Name</label>
                <input type="text" id="profileName" placeholder="Your name or username" />
              </div>
              <div class="form-group">
                <label for="profileEmail">Email (Optional)</label>
                <input type="email" id="profileEmail" placeholder="For account recovery and sync" />
              </div>
              <div class="form-group">
                <label for="profilePassword">Password</label>
                <input type="password" id="profilePassword" placeholder="Minimum 6 characters" autocomplete="new-password" />
              </div>
              <div class="form-group">
                <label for="profileAvatar">Profile Picture</label>
                <input type="file" id="profileAvatar" accept="image/*" class="file-input" />
                <div id="profileAvatarPreview" class="avatar-preview hidden">
                  <img id="profileAvatarImg" alt="Profile Avatar" />
                </div>
              </div>
              <div class="form-actions">
                <button id="createProfileBtn" class="accent-btn">Create / Sign In</button>
                <button id="importProfileBtn" class="mini-btn">Import Local</button>
                <button id="googleSignInBtn" type="button" class="mini-btn" style="background:#fff;color:#222;border:1px solid var(--border);display:flex;align-items:center;gap:6px">‚ö° Google</button>
              </div>
              <p id="authMessage" class="auth-message" style="min-height:1.2em;font-size:0.85rem;color:var(--text-dim);"></p>
              <details class="mini" style="margin-top:4px">
                <summary style="cursor:pointer;font-size:0.8rem">How sign‚Äëin works</summary>
                <small style="display:block;line-height:1.3;margin-top:4px">Email + password creates an account (or signs you in if it exists). Google button uses your Google account. First cloud login will prompt to import your local characters if the cloud is empty.</small>
              </details>
            </div>
          </div>

          <!-- Profile Dashboard (shown when logged in) -->
          <div id="profileDashboardSection" class="hidden">
            <div class="profile-info card-panel">
              <div class="profile-display">
                <div class="profile-avatar">
                  <img id="currentProfileAvatar" alt="Your Avatar" />
                </div>
                <div class="profile-details">
                  <h2 id="currentProfileName">Username</h2>
                  <p id="currentProfileEmail">email@example.com</p>
                  <p class="profile-stats">
                    <span id="characterCount">0 characters</span> ‚Ä¢ 
                    <span id="lastSyncTime">Last sync: Never</span>
                  </p>
                </div>
                <div class="profile-actions">
                  <button id="editProfileBtn" class="mini-btn">Edit Profile</button>
                  <button id="logoutBtn" class="ghost-btn">Sign Out</button>
                </div>
              </div>
            </div>

            <!-- Character Management -->
            <div class="character-management card-panel">
              <div class="section-header">
                <h3>Your Characters</h3>
                <button id="newCharacterBtn" class="accent-btn">New Character</button>
              </div>
              <div id="charactersList" class="characters-grid">
                <!-- Character cards will be dynamically inserted here -->
              </div>
            </div>

            <!-- Data Management -->
            <div class="data-management card-panel">
              <h3>Data Management</h3>
              <div class="data-actions">
                <div class="action-group">
                  <h4>Backup & Restore</h4>
                  <button id="exportAllDataBtn" class="mini-btn">Export All Data</button>
                  <button id="importAllDataBtn" class="mini-btn">Import Data</button>
                  <input type="file" id="importDataInput" accept=".json" style="display:none" />
                </div>
                <div class="action-group">
                  <h4>Cloud Sync</h4>
                  <button id="syncToCloudBtn" class="mini-btn">Sync to Cloud</button>
                  <button id="syncFromCloudBtn" class="mini-btn">Sync from Cloud</button>
                  <p class="sync-status">Status: <span id="syncStatus">Local only</span></p>
                </div>
              </div>
            </div>

            <!-- Settings -->
            <div class="profile-settings card-panel">
              <h3>Settings</h3>
              <div class="settings-grid">
                <div class="setting-item">
                  <label>
                    <input type="checkbox" id="autoSaveEnabled" checked />
                    Auto-save characters
                  </label>
                </div>
                <div class="setting-item">
                  <label>
                    <input type="checkbox" id="darkModeEnabled" />
                    Dark mode (coming soon)
                  </label>
                </div>
                <div class="setting-item">
                  <label>
                    <input type="checkbox" id="analyticsEnabled" />
                    Usage analytics
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer class="footer">Live sheet sync ‚Ä¢ <span id="recordCount">0</span> rows ‚Ä¢ <span id="lastUpdated">‚Äî</span></footer>
  <section id="view-character" class="view">
    <div class="char-edit-page">
      
      <!-- Top Row: IMG + Name -->
      <div class="char-top-row">
        <div class="char-img-container">
          <div class="char-img-box" id="charImgBox">
            <img id="charImg" class="hidden" alt="Character" />
            <div id="charImgPlaceholder">IMG</div>
          </div>
          <input type="file" id="charImgInput" accept="image/*" hidden />
        </div>
        
        <div class="char-name-container">
          <input type="text" id="charName" placeholder="Name" class="char-name-input" />
        </div>
      </div>

      <!-- Description -->
      <div class="char-description-section">
        <textarea id="charDescription" placeholder="Description" rows="4"></textarea>
      </div>

      <!-- Stats Section -->
      <div class="char-stats-edit-section">
        <div class="stats-section-label">List of values: Yes, the same list of values from the excel it will be fine. Order like on large, not a column, due to it take a too much from the space</div>
        <div class="stats-edit-grid" id="statsEditGrid">
          <div class="stat-input-box"><label>ATF</label><input type="number" id="edit-atf" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>ATM</label><input type="number" id="edit-atm" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>DEF</label><input type="number" id="edit-def" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>DEM</label><input type="number" id="edit-dem" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>PAS</label><input type="number" id="edit-pas" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>FZA</label><input type="number" id="edit-fza" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>CON</label><input type="number" id="edit-con" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>INT</label><input type="number" id="edit-int" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>SAG</label><input type="number" id="edit-sag" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>ETK</label><input type="number" id="edit-etk" value="0" min="0" max="999" /></div>
          <div class="stat-input-box"><label>EAC</label><input type="number" id="edit-eac" value="0" min="0" max="999" /></div>
          <div class="stat-input-box">...</div>
        </div>
      </div>

      <!-- Inventory Section -->
      <div class="char-inventory-section">
        <h3>Inventory</h3>
        <div class="inventory-grid">
          <div class="inventory-column">
            <div class="inv-col-header">Hands</div>
            <textarea id="invHands" placeholder="text" rows="6"></textarea>
          </div>
          <div class="inventory-column">
            <div class="inv-col-header">Equip</div>
            <textarea id="invEquip" placeholder="text" rows="6"></textarea>
          </div>
          <div class="inventory-column">
            <div class="inv-col-header">Store</div>
            <textarea id="invStore" placeholder="text" rows="6"></textarea>
          </div>
        </div>
      </div>

      <!-- Moves Section -->
      <div class="char-moves-section">
        <div class="moves-header">
          <h3>Moves</h3>
          <div class="moves-controls">
            <input type="search" id="movesSearchBar" placeholder="Search bar" />
            <button id="movesOrderBtn" type="button">button for order</button>
          </div>
        </div>
        
        <div class="moves-list" id="movesList">
          <!-- Move Card 1 -->
          <div class="move-card">
            <input type="text" class="move-name" placeholder="Move name" />
            <div class="move-content">
              <textarea class="move-desc" placeholder="Move description" rows="3"></textarea>
              <textarea class="move-tags" placeholder="Move tags" rows="2"></textarea>
            </div>
          </div>
          
          <!-- Move Card 2 -->
          <div class="move-card">
            <input type="text" class="move-name" placeholder="Move name" />
            <div class="move-content">
              <textarea class="move-desc" placeholder="Move description" rows="3"></textarea>
              <textarea class="move-tags" placeholder="Move tags" rows="2"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Actions -->
      <div class="char-save-actions">
        <button id="saveCharBtn" class="accent-btn">Save Character</button>
        <button id="exportCharBtn" class="secondary-btn">Export</button>
      </div>
      
    </div>
  </section>
    </main>
  </div>
  <button id="helpFab" class="help-fab" title="Help">?</button>
  <div id="sheetModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel">
      <header><h2>Sheet Source</h2><button id="closeSheetModal" class="close-btn" aria-label="Close">√ó</button></header>
      <p>Paste the Published CSV URL from Google Sheets. (File ‚Üí Share ‚Üí Publish to web ‚Üí CSV)</p>
      <textarea id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"></textarea>
      <div class="actions">
        <button id="saveSheetUrl" class="accent-btn">Save & Reload</button>
        <button id="clearSheetUrl" class="mini-btn">Clear Override</button>
  <button id="modalUploadBtn" class="mini-btn" type="button">Upload Local File‚Ä¶</button>
      </div>
      <small>Stored locally in your browser. Share the link hash like <code>#sheet=&lt;url&gt;</code> to preload.</small>
    </div>
  </div>
  <div id="editorModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel edit-panel">
      <header><h2 id="editTitle">Edit Row</h2><button id="closeEditorModal" class="close-btn" aria-label="Close">√ó</button></header>
      <form id="editForm"></form>
      <div class="actions">
        <button id="saveRowBtn" class="accent-btn" type="button">Save</button>
        <button id="deleteRowBtn" class="mini-btn danger" type="button">Delete</button>
      </div>
    </div>
  </div>
  <!-- Landing: Table selection (DnDex) -->
  <div id="welcomeModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-panel" style="max-width:520px">
      <header><h2>Welcome to DnDex</h2></header>
      <div class="welcome-simple">
          <label>Your Name<input id="wlName" placeholder="GM or Player" /></label>
          <div class="wl-row">
            <button id="wlCreate" class="accent-btn" style="flex:1">Host (GM)</button>
            <button id="wlSolo" class="mini-btn" style="flex:0 0 auto">Solo</button>
          </div>
          <div class="join-block">
            <label>Join Code<input id="wlInvite" placeholder="Enter code (e.g. abcd12)" /></label>
            <button id="wlJoin" class="mini-btn" style="width:100%">Join Game</button>
          </div>
          <div id="hostCodeDisplay" class="host-code" aria-live="polite" style="display:none"></div>
          <small class="muted">Share only the code. Players paste it and press Join.</small>
      </div>
    </div>
  </div>
  
  <!-- Image Cropping Modal -->
  <div id="imageCropperModal" class="image-cropper-modal hidden">
    <div class="image-cropper-content">
      <h3>Crop Character Image</h3>
      <div class="crop-instructions">
        Drag the selection area to choose the portion of the image for your character profile. 
        Use the corner and edge handles to resize the selection area.
      </div>
      <div class="crop-container" id="cropContainer">
        <img id="cropImage" />
        <div class="crop-overlay" id="cropOverlay">
          <div class="crop-handles">
            <div class="crop-handle nw"></div>
            <div class="crop-handle n"></div>
            <div class="crop-handle ne"></div>
            <div class="crop-handle w"></div>
            <div class="crop-handle e"></div>
            <div class="crop-handle sw"></div>
            <div class="crop-handle s"></div>
            <div class="crop-handle se"></div>
          </div>
        </div>
      </div>
      <div class="crop-preview">
        <div style="color: var(--text-dim); font-size: 12px; margin-bottom: 8px;">Preview:</div>
        <img id="cropPreviewImg" class="crop-preview-img" alt="Crop preview">
      </div>
      <div class="crop-actions">
        <button id="cropCancel" class="mini-btn">Cancel</button>
        <button id="cropApply" class="accent-btn">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- Character Image Context Menu -->
  <div id="imageContextMenu" class="context-menu hidden">
    <div class="context-menu-item" onclick="changeCharacterImage()">
      <span>üìÅ</span> Change Picture
    </div>
    <div class="context-menu-item" onclick="resizeCharacterImage()">
      <span>‚úÇÔ∏è</span> Resize Picture
    </div>
    <div class="context-menu-item" onclick="deleteCharacterImage()">
      <span>üóëÔ∏è</span> Delete Image
    </div>
  </div>
  
  <script src="js/config.js"></script>
  <script src="js/persist.js"></script>
  <script src="js/sheet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Firebase (optional, used when 'Use Firebase' is enabled) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!-- Provide config via firebase-config.js (ignored) or fallback sample for dev reference -->
  <script src="js/firebase-config.sample.js" data-sample="true"></script>
  <script src="js/firebase-init.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/compendium.js"></script>
  <script src="js/entities.js"></script>
  <script src="js/items.js"></script>
  <script src="js/events.js"></script>
  <script src="js/conditions.js"></script>
  <script src="js/items-entities-info.js"></script>
  <script src="js/character-database.js"></script>
  <script src="js/excel-integration.js"></script>
  <script>if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{})); }</script>
</body>
</html>
